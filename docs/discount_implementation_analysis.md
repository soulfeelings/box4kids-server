# –ê–Ω–∞–ª–∏–∑ –∫–∞—á–µ—Å—Ç–≤–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ —Å–∏—Å—Ç–µ–º—ã —Å–∫–∏–¥–æ–∫

## –û–±–∑–æ—Ä

–ê–Ω–∞–ª–∏–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –≤–µ—Ç–∫–µ `discount` –ø–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—é —Å `main` –¥–ª—è –æ—Ü–µ–Ω–∫–∏ –∫–∞—á–µ—Å—Ç–≤–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ —Å–∏—Å—Ç–µ–º—ã —Å–∫–∏–¥–æ–∫.

## üöÄ –°–µ—Ä–≤–µ—Ä–Ω–∞—è —á–∞—Å—Ç—å (Server) - –û—Ü–µ–Ω–∫–∞: 8/10

### ‚úÖ –°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã

1. **–ö–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞**: –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω –∞–ª–≥–æ—Ä–∏—Ç–º "N-1 —Å–∞–º—ã—Ö –¥–µ—à–µ–≤—ã—Ö –Ω–∞–±–æ—Ä–æ–≤" —Å–æ–≥–ª–∞—Å–Ω–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º
2. **–†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –æ–ø–ª–∞—á–µ–Ω–Ω—ã—Ö –∏ –Ω–æ–≤—ã—Ö –ø–æ–¥–ø–∏—Å–æ–∫**: –ü—Ä–∞–≤–∏–ª—å–Ω–æ —É—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è, —á—Ç–æ –æ–ø–ª–∞—á–µ–Ω–Ω—ã–µ –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–µ –¥–æ–ª–∂–Ω—ã –∏–∑–º–µ–Ω—è—Ç—å—Å—è
3. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ—Å—á–µ—Ç**: –°–∫–∏–¥–∫–∏ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞—é—Ç—Å—è –ø—Ä–∏ –≤—Å–µ—Ö —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏—è—Ö:
   - –°–æ–∑–¥–∞–Ω–∏–µ/—É–¥–∞–ª–µ–Ω–∏–µ –¥–µ—Ç–µ–π
   - –ò–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–æ–∫
   - –û—Ç–º–µ–Ω–∞ –ø–æ–¥–ø–∏—Å–æ–∫
4. **API endpoint**: –î–æ–±–∞–≤–ª–µ–Ω `/recalculate-discounts` –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –ø–µ—Ä–µ—Å—á–µ—Ç–∞
5. **–°—Ö–µ–º—ã –¥–∞–Ω–Ω—ã—Ö**: –î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª–µ `final_price` –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ —Ü–µ–Ω—ã —Å–æ —Å–∫–∏–¥–∫–æ–π
6. **–ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ**: `individual_price` —Ç–µ–ø–µ—Ä—å —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è —Å —É—á–µ—Ç–æ–º —Å–∫–∏–¥–∫–∏

### ‚ö†Ô∏è –ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏

1. **–¶–∏–∫–ª–∏—á–µ—Å–∫–∏–µ –∏–º–ø–æ—Ä—Ç—ã**: –í `child_service.py` –∏ `subscription_service.py` –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –≤–∑–∞–∏–º–Ω—ã–µ –∏–º–ø–æ—Ä—Ç—ã –≤–Ω—É—Ç—Ä–∏ –º–µ—Ç–æ–¥–æ–≤ - –ø–ª–æ—Ö–∞—è –ø—Ä–∞–∫—Ç–∏–∫–∞
2. **–ù–µ—Ç –≤–∞–ª–∏–¥–∞—Ü–∏–∏**: –ù–µ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –ø—Ä–æ—Ü–µ–Ω—Ç–∞ —Å–∫–∏–¥–∫–∏ (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å 0-100)
3. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**: –ú–µ—Ç–æ–¥ `_calculate_discount_for_user` –¥–µ–ª–∞–µ—Ç –º–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –ë–î –≤ —Ü–∏–∫–ª–µ
4. **–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞**: –õ–æ–≥–∏–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–æ–∫ –ø–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è

### üìù –ö–ª—é—á–µ–≤—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è

```python
# services/subscription_service.py
- discount_percent = self._calculate_discount(child.parent_id)
+ discounts = self._calculate_discount_for_user(child.parent_id)
+ discount_percent = discounts.get(child.id, 0.0)
+ final_price = plan.price_monthly * (1 - discount_percent / 100)

- individual_price=plan.price_monthly,
+ individual_price=final_price,  # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ü–µ–Ω—É —Å–æ —Å–∫–∏–¥–∫–æ–π
```

## üé® –§—Ä–æ–Ω—Ç–µ–Ω–¥ (Web) - –û—Ü–µ–Ω–∫–∞: 7/10

### ‚úÖ –°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã

1. **–í–∏–∑—É–∞–ª—å–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–∫–∏–¥–æ–∫**: –ö—Ä–∞—Å–∏–≤–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è:
   - –ü—Ä–æ—Ü–µ–Ω—Ç —Å–∫–∏–¥–∫–∏
   - –ë–∞–∑–æ–≤–∞—è —Ü–µ–Ω–∞
   - –§–∏–Ω–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞ —Å–æ —Å–∫–∏–¥–∫–æ–π
2. **–ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö**: –ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è/–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ä–µ–±–µ–Ω–∫–∞ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è `fetchInitData()`
3. **Fallback –ª–æ–≥–∏–∫–∞**: –ï—Å–ª–∏ `final_price` –Ω–µ –ø—Ä–∏—Ö–æ–¥–∏—Ç —Å API, —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ
4. **–û–±—â–∞—è —Å—É–º–º–∞**: –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –æ–±—â–∞—è —Å–∫–∏–¥–∫–∞ –∏ –∏—Ç–æ–≥–æ–≤–∞—è —Å—É–º–º–∞
5. **–£—Å–ª–æ–≤–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ**: –°–∫–∏–¥–∫–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–Ω–∞ –µ—Å—Ç—å

### ‚ö†Ô∏è –ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏

1. **Type safety**: –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `(subscription as any).final_price` - –Ω–∞—Ä—É—à–µ–Ω–∏–µ —Ç–∏–ø–∏–∑–∞—Ü–∏–∏
2. **–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏–∫–∏**: –†–∞—Å—á–µ—Ç —Ü–µ–Ω—ã —Å–æ —Å–∫–∏–¥–∫–æ–π –¥—É–±–ª–∏—Ä—É–µ—Ç—Å—è –≤ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –º–µ—Å—Ç–∞—Ö
3. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤ –¥—Ä—É–≥–∏—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞—Ö**: –°–∫–∏–¥–∫–∏ –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –≤ `SubscriptionPlanCard.tsx`
4. **–°–ª–æ–∂–Ω–∞—è –ª–æ–≥–∏–∫–∞ –≤ JSX**: –†–∞—Å—á–µ—Ç—ã –ø—Ä—è–º–æ –≤ —à–∞–±–ª–æ–Ω–µ —É—Å–ª–æ–∂–Ω—è—é—Ç —á–∏—Ç–∞–µ–º–æ—Å—Ç—å

### üìù –ö–ª—é—á–µ–≤—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è

```typescript
// PaymentStep.tsx
+ const finalPrice = (subscription as any).final_price ||
+   basePrice * (1 - (subscription.discount_percent || 0) / 100);

// –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–∫–∏–¥–∫—É —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–Ω–∞ –µ—Å—Ç—å
+ {subscription[0]?.discount_percent && subscription[0].discount_percent > 0 ? (
+   // –î–µ—Ç–∞–ª—å–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–∫–∏–¥–∫–∏
+ ) : (
+   // –û–±—ã—á–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ü–µ–Ω—ã
+ )}
```

## üìã –û–±—â–∞—è –æ—Ü–µ–Ω–∫–∞: 7.5/10

### ‚úÖ –ß—Ç–æ —Ö–æ—Ä–æ—à–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

- –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ—Å—á–µ—Ç —Å–∫–∏–¥–æ–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- –í–∏–∑—É–∞–ª—å–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–∫–∏–¥–æ–∫ –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω–æ–µ
- API –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ñ–∏–Ω–∞–ª—å–Ω—É—é —Ü–µ–Ω—É
- –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ (–Ω–æ–≤—ã–µ/–æ–ø–ª–∞—á–µ–Ω–Ω—ã–µ –ø–æ–¥–ø–∏—Å–∫–∏)

### üîß –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —É–ª—É—á—à–µ–Ω–∏—é

#### –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ (Priority 1)

1. **–ò—Å–ø—Ä–∞–≤–∏—Ç—å —Ü–∏–∫–ª–∏—á–µ—Å–∫–∏–µ –∏–º–ø–æ—Ä—Ç—ã** –≤ —Å–µ—Ä–≤–∏—Å–∞—Ö - –≤—ã–Ω–µ—Å—Ç–∏ –≤ dependency injection
2. **–î–æ–±–∞–≤–∏—Ç—å —Ç–∏–ø–∏–∑–∞—Ü–∏—é** –¥–ª—è `final_price` –≤ TypeScript –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞—Ö
3. **–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å—ã** –∫ –ë–î - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å JOIN –≤–º–µ—Å—Ç–æ —Ü–∏–∫–ª–æ–≤

#### –í–∞–∂–Ω—ã–µ (Priority 2)

4. **–î–æ–±–∞–≤–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é** –ø—Ä–æ—Ü–µ–Ω—Ç–∞ —Å–∫–∏–¥–∫–∏ (0-100%)
5. **–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å —Å–∫–∏–¥–∫–∏** –Ω–∞ —ç—Ç–∞–ø–µ –≤—ã–±–æ—Ä–∞ –ø–ª–∞–Ω–æ–≤ –≤ `SubscriptionPlanCard`
6. **–í—ã–Ω–µ—Å—Ç–∏ —Ä–∞—Å—á–µ—Ç —Ü–µ–Ω—ã** –≤ —É—Ç–∏–ª–∏—Ç–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

#### –ñ–µ–ª–∞—Ç–µ–ª—å–Ω—ã–µ (Priority 3)

7. **–î–æ–±–∞–≤–∏—Ç—å —Ç–µ—Å—Ç—ã** –¥–ª—è –ª–æ–≥–∏–∫–∏ —Ä–∞—Å—á–µ—Ç–∞ —Å–∫–∏–¥–æ–∫
8. **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** –æ–ø–µ—Ä–∞—Ü–∏–π –ø–µ—Ä–µ—Å—á–µ—Ç–∞ —Å–∫–∏–¥–æ–∫
9. **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ** —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Ä–∞—Å—á–µ—Ç–∞ —Å–∫–∏–¥–æ–∫

## üß™ –¢–µ—Å—Ç–æ–≤—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏

–†–µ–∞–ª–∏–∑–∞—Ü–∏—è –¥–æ–ª–∂–Ω–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å:

1. ‚úÖ –û–¥–∏–Ω —Ä–µ–±–µ–Ω–æ–∫ - –Ω–µ—Ç —Å–∫–∏–¥–æ–∫
2. ‚úÖ –î–≤–∞ —Ä–µ–±–µ–Ω–∫–∞ —Å –Ω–æ–≤—ã–º–∏ –ø–æ–¥–ø–∏—Å–∫–∞–º–∏ - —Å–∫–∏–¥–∫–∞ –Ω–∞ –±–æ–ª–µ–µ –¥–µ—à–µ–≤—É—é
3. ‚úÖ –û–¥–∏–Ω –æ–ø–ª–∞—á–µ–Ω–Ω—ã–π + –æ–¥–∏–Ω –Ω–æ–≤—ã–π - —Å–∫–∏–¥–∫–∞ –Ω–∞ –Ω–æ–≤—É—é
4. ‚úÖ –í—Å–µ –ø–æ–¥–ø–∏—Å–∫–∏ –æ–ø–ª–∞—á–µ–Ω—ã - –Ω–µ—Ç –Ω–æ–≤—ã—Ö —Å–∫–∏–¥–æ–∫
5. ‚ö†Ô∏è –û—Ç–º–µ–Ω–µ–Ω–Ω—ã–µ –ø–æ–¥–ø–∏—Å–∫–∏ –∏—Å–∫–ª—é—á–∞—é—Ç—Å—è –∏–∑ —Ä–∞—Å—á–µ—Ç–∞
6. ‚ö†Ô∏è –ü—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –æ–ø–ª–∞—á–µ–Ω–Ω—ã–µ –ø–æ–¥–ø–∏—Å–∫–∏ —É—á–∏—Ç—ã–≤–∞—é—Ç—Å—è

## üîç –°—Ç–∞—Ç—É—Å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º

| –¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ                   | –°—Ç–∞—Ç—É—Å | –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ  |
| ---------------------------- | ------ | ----------- |
| 20% —Å–∫–∏–¥–∫–∞ –Ω–∞ N-1 –¥–µ—à–µ–≤—ã—Ö    | ‚úÖ     | –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ |
| –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –Ω–æ–≤—ã—Ö –ø–æ–¥–ø–∏—Å–æ–∫     | ‚úÖ     | –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ |
| –ù–µ–∏–∑–º–µ–Ω–Ω–æ—Å—Ç—å –æ–ø–ª–∞—á–µ–Ω–Ω—ã—Ö      | ‚úÖ     | –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ |
| –ò—Å–∫–ª—é—á–µ–Ω–∏–µ CANCELLED/EXPIRED | ‚úÖ     | –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ |
| –£—á–µ—Ç PAUSED –∫–∞–∫ –æ–ø–ª–∞—á–µ–Ω–Ω—ã—Ö   | ‚úÖ     | –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ |
| –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–µ     | ‚úÖ     | –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ |
| –ê–≤—Ç–æ–ø–µ—Ä–µ—Å—á–µ—Ç –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö  | ‚úÖ     | –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ |

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–†–µ–∞–ª–∏–∑–∞—Ü–∏—è **—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞** –∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –±–∏–∑–Ω–µ—Å-—Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º. –û—Å–Ω–æ–≤–Ω—ã–µ –Ω–µ–¥–æ—Å—Ç–∞—Ç–∫–∏ –∫–∞—Å–∞—é—Ç—Å—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã—Ö —Ä–µ—à–µ–Ω–∏–π –∏ –º–æ–≥—É—Ç –±—ã—Ç—å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ª–æ–≥–∏–∫–∏ —Ä–∞–±–æ—Ç—ã —Å–∏—Å—Ç–µ–º—ã.
