# –ü–ª–∞–Ω –≤–Ω–µ–¥—Ä–µ–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã —Å–∫–∏–¥–æ–∫

## –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞

### –ü—Ä–∞–≤–∏–ª–∞ —Å–∫–∏–¥–æ–∫

- **20% —Å–∫–∏–¥–∫–∞** –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∫–æ –≤—Å–µ–º –¥–µ—Ç—è–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –∫—Ä–æ–º–µ –ø–µ—Ä–≤–æ–≥–æ
- **–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç —Å–∫–∏–¥–∫–∏:** –°–∫–∏–¥–∫–∞ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∫ **–Ω–æ–≤—ã–º –ø–æ–¥–ø–∏—Å–∫–∞–º**, –∞ –Ω–µ –∫ —É–∂–µ –æ–ø–ª–∞—á–µ–Ω–Ω—ã–º
- **–õ–æ–≥–∏–∫–∞ –≤—ã–±–æ—Ä–∞ –ø–ª–∞–Ω–∞ –¥–ª—è —Å–∫–∏–¥–∫–∏:**
  - –ï—Å–ª–∏ –≤—Å–µ –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–æ–≤—ã–µ ‚Üí —Å–∫–∏–¥–∫–∞ –∫ —Å–∞–º–æ–º—É –¥–µ—à–µ–≤–æ–º—É –ø–ª–∞–Ω—É
  - –ï—Å–ª–∏ –µ—Å—Ç—å –æ–ø–ª–∞—á–µ–Ω–Ω—ã–µ –∏ –Ω–æ–≤—ã–µ ‚Üí —Å–∫–∏–¥–∫–∞ –∫ –Ω–æ–≤–æ–π –ø–æ–¥–ø–∏—Å–∫–µ (–∏–ª–∏ –∫ —Å–∞–º–æ–π –¥–µ—à–µ–≤–æ–π –∏–∑ –Ω–æ–≤—ã—Ö)
  - –ï—Å–ª–∏ –≤—Å–µ –ø–æ–¥–ø–∏—Å–∫–∏ –æ–ø–ª–∞—á–µ–Ω—ã ‚Üí —Å–∫–∏–¥–æ–∫ –Ω–µ—Ç
- **–ù–µ–∏–∑–º–µ–Ω–Ω–æ—Å—Ç—å –æ–ø–ª–∞—á–µ–Ω–Ω—ã—Ö –ø–æ–¥–ø–∏—Å–æ–∫:** –û–ø–ª–∞—á–µ–Ω–Ω—ã–µ –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–µ –∏–∑–º–µ–Ω—è—é—Ç—Å—è –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –Ω–æ–≤—ã—Ö –¥–µ—Ç–µ–π

### –°—Ç–∞—Ç—É—Å—ã –ø–æ–¥–ø–∏—Å–æ–∫ –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ —Å–∫–∏–¥–æ–∫

#### ‚úÖ **–£—á–∏—Ç—ã–≤–∞–µ–º—ã–µ —Å—Ç–∞—Ç—É—Å—ã:**

- `PENDING_PAYMENT` - –æ–∂–∏–¥–∞–µ—Ç –æ–ø–ª–∞—Ç—ã (–Ω–æ–≤–∞—è –ø–æ–¥–ø–∏—Å–∫–∞)
- `ACTIVE` - –∞–∫—Ç–∏–≤–Ω–∞—è –∏ –æ–ø–ª–∞—á–µ–Ω–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞
- `PAUSED` - –ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω–∞—è, –Ω–æ –æ–ø–ª–∞—á–µ–Ω–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞

#### ‚ùå **–ò—Å–∫–ª—é—á–∞–µ–º—ã–µ —Å—Ç–∞—Ç—É—Å—ã:**

- `CANCELLED` - –æ—Ç–º–µ–Ω–µ–Ω–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞ (–Ω–µ –≤–ª–∏—è–µ—Ç –Ω–∞ —Å–∫–∏–¥–∫–∏)
- `EXPIRED` - –∏—Å—Ç–µ–∫—à–∞—è –ø–æ–¥–ø–∏—Å–∫–∞ (–Ω–µ –≤–ª–∏—è–µ—Ç –Ω–∞ —Å–∫–∏–¥–∫–∏)

#### üìã **–õ–æ–≥–∏–∫–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞:**

```python
# –ü–æ–¥–ø–∏—Å–∫–∞ —Å—á–∏—Ç–∞–µ—Ç—Å—è "–∞–∫—Ç–∏–≤–Ω–æ–π" –µ—Å–ª–∏:
- payment.status == "completed"
- expires_at > —Ç–µ–∫—É—â–µ–µ_–≤—Ä–µ–º—è
- is_paused == False

# –ü–æ–¥–ø–∏—Å–∫–∞ —Å—á–∏—Ç–∞–µ—Ç—Å—è "–Ω–æ–≤–æ–π" –µ—Å–ª–∏:
- payment.status != "completed" –∏–ª–∏ payment == None
- status == "pending_payment"

# –ü–æ–¥–ø–∏—Å–∫–∞ –∏—Å–∫–ª—é—á–∞–µ—Ç—Å—è –∏–∑ —Ä–∞—Å—á–µ—Ç–∞ –µ—Å–ª–∏:
- status == "cancelled" –∏–ª–∏ "expired"
- payment.status == "failed", "refunded", "expired"
```

### –ü—Ä–∏–º–µ—Ä—ã –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —Å–∫–∏–¥–æ–∫

**–°—Ü–µ–Ω–∞—Ä–∏–π 1: –ù–æ–≤—ã–µ –ø–æ–¥–ø–∏—Å–∫–∏**

- –†–µ–±–µ–Ω–æ–∫ 1: –ø–ª–∞–Ω "–ë–∞–∑–æ–≤—ã–π" (6 –∏–≥—Ä—É—à–µ–∫) - $100/–º–µ—Å
- –†–µ–±–µ–Ω–æ–∫ 2: –ø–ª–∞–Ω "–ü—Ä–µ–º–∏—É–º" (9 –∏–≥—Ä—É—à–µ–∫) - $150/–º–µ—Å
- **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –°–∫–∏–¥–∫–∞ 20% –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∫ "–ë–∞–∑–æ–≤–æ–º—É" –ø–ª–∞–Ω—É = $80 –≤–º–µ—Å—Ç–æ $100

**–°—Ü–µ–Ω–∞—Ä–∏–π 2: –ù–æ–≤—ã–µ –ø–æ–¥–ø–∏—Å–∫–∏**

- –†–µ–±–µ–Ω–æ–∫ 1: –ø–ª–∞–Ω "–ü—Ä–µ–º–∏—É–º" (9 –∏–≥—Ä—É—à–µ–∫) - $150/–º–µ—Å
- –†–µ–±–µ–Ω–æ–∫ 2: –ø–ª–∞–Ω "–ë–∞–∑–æ–≤—ã–π" (6 –∏–≥—Ä—É—à–µ–∫) - $100/–º–µ—Å
- **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –°–∫–∏–¥–∫–∞ 20% –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∫ "–ë–∞–∑–æ–≤–æ–º—É" –ø–ª–∞–Ω—É = $80 –≤–º–µ—Å—Ç–æ $100

**–°—Ü–µ–Ω–∞—Ä–∏–π 3: –£–∂–µ –µ—Å—Ç—å –æ–ø–ª–∞—á–µ–Ω–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞**

- –†–µ–±–µ–Ω–æ–∫ 1: –ø–ª–∞–Ω "–ë–∞–∑–æ–≤—ã–π" (6 –∏–≥—Ä—É—à–µ–∫) - $100/–º–µ—Å (—É–∂–µ –æ–ø–ª–∞—á–µ–Ω)
- –†–µ–±–µ–Ω–æ–∫ 2: –ø–ª–∞–Ω "–ü—Ä–µ–º–∏—É–º" (9 –∏–≥—Ä—É—à–µ–∫) - $150/–º–µ—Å (–Ω–æ–≤–∞—è –ø–æ–¥–ø–∏—Å–∫–∞)
- **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –°–∫–∏–¥–∫–∞ 20% –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∫ –ù–û–í–û–ô –ø–æ–¥–ø–∏—Å–∫–µ "–ü—Ä–µ–º–∏—É–º" = $120 –≤–º–µ—Å—Ç–æ $150
- **–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –û–ø–ª–∞—á–µ–Ω–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞ –æ—Å—Ç–∞–µ—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π

**–°—Ü–µ–Ω–∞—Ä–∏–π 4: –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø–æ–¥–ø–∏—Å–∫–∏**

- –†–µ–±–µ–Ω–æ–∫ 1: –ø–ª–∞–Ω "–ë–∞–∑–æ–≤—ã–π" (6 –∏–≥—Ä—É—à–µ–∫) - $100/–º–µ—Å (—É–∂–µ –æ–ø–ª–∞—á–µ–Ω)
- –†–µ–±–µ–Ω–æ–∫ 2: –ø–ª–∞–Ω "–°—Ç–∞–Ω–¥–∞—Ä—Ç" (8 –∏–≥—Ä—É—à–µ–∫) - $120/–º–µ—Å (—É–∂–µ –æ–ø–ª–∞—á–µ–Ω)
- –†–µ–±–µ–Ω–æ–∫ 3: –ø–ª–∞–Ω "–ü—Ä–µ–º–∏—É–º" (9 –∏–≥—Ä—É—à–µ–∫) - $150/–º–µ—Å (–Ω–æ–≤–∞—è –ø–æ–¥–ø–∏—Å–∫–∞)
- **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –°–∫–∏–¥–∫–∞ 20% –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∫ –ù–û–í–û–ô –ø–æ–¥–ø–∏—Å–∫–µ "–ü—Ä–µ–º–∏—É–º" = $120 –≤–º–µ—Å—Ç–æ $150
- **–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –æ–ø–ª–∞—á–µ–Ω–Ω—ã–µ –ø–æ–¥–ø–∏—Å–∫–∏ –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π

**–°—Ü–µ–Ω–∞—Ä–∏–π 5: –° –æ—Ç–º–µ–Ω–µ–Ω–Ω—ã–º–∏ –ø–æ–¥–ø–∏—Å–∫–∞–º–∏**

- –†–µ–±–µ–Ω–æ–∫ 1: –ø–ª–∞–Ω "–ë–∞–∑–æ–≤—ã–π" (6 –∏–≥—Ä—É—à–µ–∫) - $100/–º–µ—Å (—Å—Ç–∞—Ç—É—Å: CANCELLED)
- –†–µ–±–µ–Ω–æ–∫ 2: –ø–ª–∞–Ω "–ü—Ä–µ–º–∏—É–º" (9 –∏–≥—Ä—É—à–µ–∫) - $150/–º–µ—Å (–Ω–æ–≤–∞—è –ø–æ–¥–ø–∏—Å–∫–∞)
- **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –°–∫–∏–¥–∫–∞ 20% –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∫ "–ü—Ä–µ–º–∏—É–º" = $120 –≤–º–µ—Å—Ç–æ $150
- **–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –û—Ç–º–µ–Ω–µ–Ω–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–µ —É—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –≤ —Ä–∞—Å—á–µ—Ç–µ

**–°—Ü–µ–Ω–∞—Ä–∏–π 6: –° –ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–º–∏ –ø–æ–¥–ø–∏—Å–∫–∞–º–∏**

- –†–µ–±–µ–Ω–æ–∫ 1: –ø–ª–∞–Ω "–ë–∞–∑–æ–≤—ã–π" (6 –∏–≥—Ä—É—à–µ–∫) - $100/–º–µ—Å (—Å—Ç–∞—Ç—É—Å: PAUSED, –æ–ø–ª–∞—á–µ–Ω)
- –†–µ–±–µ–Ω–æ–∫ 2: –ø–ª–∞–Ω "–ü—Ä–µ–º–∏—É–º" (9 –∏–≥—Ä—É—à–µ–∫) - $150/–º–µ—Å (–Ω–æ–≤–∞—è –ø–æ–¥–ø–∏—Å–∫–∞)
- **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –°–∫–∏–¥–∫–∞ 20% –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∫ "–ü—Ä–µ–º–∏—É–º" = $120 –≤–º–µ—Å—Ç–æ $150
- **–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –ü—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω–∞—è –æ–ø–ª–∞—á–µ–Ω–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞ —É—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –∫–∞–∫ "–æ–ø–ª–∞—á–µ–Ω–Ω–∞—è"

## –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ

### ‚úÖ –ß—Ç–æ —É–∂–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

- –ü–æ–ª–µ `discount_percent` –≤ –º–æ–¥–µ–ª–∏ `Subscription` —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
- –õ–æ–≥–∏–∫–∞ —Ä–∞—Å—á–µ—Ç–∞ —Å–∫–∏–¥–∫–∏ 20% –¥–ª—è –≤—Ç–æ—Ä–æ–≥–æ —Ä–µ–±–µ–Ω–∫–∞ –∏ –¥–∞–ª–µ–µ —É–∂–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞
- –ü–æ–ª–µ `individual_price` –≤ `Subscription` –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ñ–∏–Ω–∞–ª—å–Ω–æ–π —Ü–µ–Ω—ã

### ‚ùå –ß—Ç–æ –Ω—É–∂–Ω–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å

- `individual_price` —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –±–µ–∑ —É—á–µ—Ç–∞ —Å–∫–∏–¥–∫–∏ (—Ä–∞–≤–µ–Ω `plan.price_monthly`)
- –§—Ä–æ–Ω—Ç–µ–Ω–¥ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç `plan.price_monthly` –≤–º–µ—Å—Ç–æ —Ü–µ–Ω—ã —Å–æ —Å–∫–∏–¥–∫–æ–π
- –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –ª–æ–≥–∏–∫–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —Å–∫–∏–¥–∫–∏ –∫ —Å–∞–º–æ–º—É –¥–µ—à–µ–≤–æ–º—É –ø–ª–∞–Ω—É
- **–í–ê–ñ–ù–û:** –ù–µ–æ–±—Ö–æ–¥–∏–º–æ —É—á–µ—Å—Ç—å, —á—Ç–æ –æ–ø–ª–∞—á–µ–Ω–Ω—ã–µ –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–µ –¥–æ–ª–∂–Ω—ã –∏–∑–º–µ–Ω—è—Ç—å—Å—è –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –Ω–æ–≤—ã—Ö –¥–µ—Ç–µ–π

## –ü–ª–∞–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### 1. –û–±–Ω–æ–≤–∏—Ç—å –ª–æ–≥–∏–∫—É —Ä–∞—Å—á–µ—Ç–∞ —Å–∫–∏–¥–æ–∫

**–§–∞–π–ª:** `server/services/subscription_service.py`

```python
def _calculate_discount_for_user(self, user_id: int) -> Dict[int, float]:
    """–†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç —Å–∫–∏–¥–∫–∏ –¥–ª—è –≤—Å–µ—Ö –¥–µ—Ç–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    children = self.child_repo.get_by_parent_id(user_id)

    if len(children) <= 1:
        return {child.id: 0.0 for child in children}

    # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ –ø–æ–¥–ø–∏—Å–∫–∏ (–∏—Å–∫–ª—é—á–∞–µ–º –æ—Ç–º–µ–Ω–µ–Ω–Ω—ã–µ –∏ –∏—Å—Ç–µ–∫—à–∏–µ)
    subscriptions = []
    for child in children:
        # –ü–æ–ª—É—á–∞–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –ø–æ–¥–ø–∏—Å–∫—É
        subscription = self.subscription_repo.get_active_by_child_id(child.id)
        if subscription and subscription.status not in [SubscriptionStatus.CANCELLED, SubscriptionStatus.EXPIRED]:
            subscriptions.append(subscription)
            continue

        # –ü–æ–ª—É—á–∞–µ–º –æ–∂–∏–¥–∞—é—â—É—é –æ–ø–ª–∞—Ç—ã –ø–æ–¥–ø–∏—Å–∫—É
        subscription = self.subscription_repo.get_pending_payment_by_child_id(child.id)
        if subscription and subscription.status not in [SubscriptionStatus.CANCELLED, SubscriptionStatus.EXPIRED]:
            subscriptions.append(subscription)
            continue

        # –ü–æ–ª—É—á–∞–µ–º –ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—É—é –ø–æ–¥–ø–∏—Å–∫—É (–µ—Å–ª–∏ –µ—Å—Ç—å)
        paused_subscription = self.subscription_repo.get_paused_by_child_id(child.id)
        if paused_subscription and paused_subscription.status == SubscriptionStatus.PAUSED:
            subscriptions.append(paused_subscription)

    if len(subscriptions) <= 1:
        return {child.id: 0.0 for child in children}

    # –†–∞–∑–¥–µ–ª—è–µ–º –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ –æ–ø–ª–∞—á–µ–Ω–Ω—ã–µ –∏ –Ω–æ–≤—ã–µ
    paid_subscriptions = [
        s for s in subscriptions
        if s.payment and s.payment.status == PaymentStatus.COMPLETED
        and s.status in [SubscriptionStatus.ACTIVE, SubscriptionStatus.PAUSED]
    ]
    new_subscriptions = [
        s for s in subscriptions
        if not s.payment or s.payment.status != PaymentStatus.COMPLETED
        or s.status == SubscriptionStatus.PENDING_PAYMENT
    ]

    # –ï—Å–ª–∏ –µ—Å—Ç—å —Ç–æ–ª—å–∫–æ –æ–ø–ª–∞—á–µ–Ω–Ω—ã–µ –ø–æ–¥–ø–∏—Å–∫–∏ - —Å–∫–∏–¥–æ–∫ –Ω–µ—Ç
    if not new_subscriptions:
        return {child.id: 0.0 for child in children}

    # –ï—Å–ª–∏ –µ—Å—Ç—å —Ç–æ–ª—å–∫–æ –Ω–æ–≤—ã–µ –ø–æ–¥–ø–∏—Å–∫–∏ - –ø—Ä–∏–º–µ–Ω—è–µ–º —Å—Ç–∞—Ä—É—é –ª–æ–≥–∏–∫—É
    if not paid_subscriptions:
        cheapest_subscription = min(subscriptions, key=lambda s: s.plan.price_monthly)
        discounts = {}
        for child in children:
            child_subscription = next((s for s in subscriptions if s.child_id == child.id), None)
            if child_subscription and child_subscription.id == cheapest_subscription.id:
                discounts[child.id] = 20.0
            else:
                discounts[child.id] = 0.0
        return discounts

    # –ï—Å–ª–∏ –µ—Å—Ç—å –∏ –æ–ø–ª–∞—á–µ–Ω–Ω—ã–µ, –∏ –Ω–æ–≤—ã–µ –ø–æ–¥–ø–∏—Å–∫–∏ - —Å–∫–∏–¥–∫–∞ —Ç–æ–ª—å–∫–æ –∫ –Ω–æ–≤–æ–π
    if len(new_subscriptions) == 1:
        # –û–¥–Ω–∞ –Ω–æ–≤–∞—è –ø–æ–¥–ø–∏—Å–∫–∞ - –ø—Ä–∏–º–µ–Ω—è–µ–º –∫ –Ω–µ–π —Å–∫–∏–¥–∫—É
        new_subscription = new_subscriptions[0]
        discounts = {}
        for child in children:
            child_subscription = next((s for s in subscriptions if s.child_id == child.id), None)
            if child_subscription and child_subscription.id == new_subscription.id:
                discounts[child.id] = 20.0
            else:
                discounts[child.id] = 0.0
        return discounts
    else:
        # –ù–µ—Å–∫–æ–ª—å–∫–æ –Ω–æ–≤—ã—Ö –ø–æ–¥–ø–∏—Å–æ–∫ - –ø—Ä–∏–º–µ–Ω—è–µ–º –∫ —Å–∞–º–æ–π –¥–µ—à–µ–≤–æ–π –∏–∑ –Ω–æ–≤—ã—Ö
        cheapest_new_subscription = min(new_subscriptions, key=lambda s: s.plan.price_monthly)
        discounts = {}
        for child in children:
            child_subscription = next((s for s in subscriptions if s.child_id == child.id), None)
            if child_subscription and child_subscription.id == cheapest_new_subscription.id:
                discounts[child.id] = 20.0
            else:
                discounts[child.id] = 0.0
        return discounts
```

### 2. –ò—Å–ø—Ä–∞–≤–∏—Ç—å —Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏

**–§–∞–π–ª:** `server/services/subscription_service.py`

```python
def create_subscription_order(self, request: SubscriptionCreateRequest) -> SubscriptionResponse:
    # ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ ...

    # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Å–∫–∏–¥–∫–∏ –¥–ª—è –≤—Å–µ—Ö –¥–µ—Ç–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    discounts = self._calculate_discount_for_user(child.parent_id)
    discount_percent = discounts.get(child.id, 0.0)

    # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—É—é —Ü–µ–Ω—É
    final_price = plan.price_monthly * (1 - discount_percent / 100)

    subscription = Subscription(
        child_id=request.child_id,
        plan_id=request.plan_id,
        delivery_info_id=request.delivery_info_id,
        discount_percent=discount_percent,
        individual_price=final_price,  # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ü–µ–Ω—É —Å–æ —Å–∫–∏–¥–∫–æ–π
        expires_at=datetime.now(timezone.utc) + relativedelta(months=1)
    )
```

### 3. –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ final_price –≤ —Å—Ö–µ–º—ã –æ—Ç–≤–µ—Ç–æ–≤

**–§–∞–π–ª:** `server/schemas/subscription_schemas.py`

```python
class SubscriptionWithDetailsResponse(BaseModel):
    # ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–æ–ª—è ...
    plan_price: float  # –ë–∞–∑–æ–≤–∞—è —Ü–µ–Ω–∞ –ø–ª–∞–Ω–∞
    final_price: float  # –¶–µ–Ω–∞ —Å–æ —Å–∫–∏–¥–∫–æ–π

    class Config:
        from_attributes = True
```

### 4. –û–±–Ω–æ–≤–∏—Ç—å —Å–µ—Ä–≤–∏—Å –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ final_price

**–§–∞–π–ª:** `server/services/subscription_service.py`

```python
def get_user_subscriptions(self, user_id: int) -> List[SubscriptionWithDetailsResponse]:
    # ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ ...

    subscription_data = SubscriptionWithDetailsResponse(
        # ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–æ–ª—è ...
        plan_price=subscription.plan.price_monthly,
        final_price=subscription.individual_price,  # –¶–µ–Ω–∞ —Å–æ —Å–∫–∏–¥–∫–æ–π
        # ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø–æ–ª—è ...
    )
```

### 5. –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥ –ø–µ—Ä–µ—Å—á–µ—Ç–∞ —Å–∫–∏–¥–æ–∫

**–§–∞–π–ª:** `server/services/subscription_service.py`

```python
def recalculate_discounts_for_user(self, user_id: int) -> None:
    """–ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç —Å–∫–∏–¥–∫–∏ –¥–ª—è –≤—Å–µ—Ö –ø–æ–¥–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    discounts = self._calculate_discount_for_user(user_id)

    for child_id, discount_percent in discounts.items():
        subscription = self.subscription_repo.get_active_by_child_id(child_id)
        if not subscription:
            subscription = self.subscription_repo.get_pending_payment_by_child_id(child_id)

        if subscription:
            # –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —Ü–µ–Ω—É
            new_price = subscription.plan.price_monthly * (1 - discount_percent / 100)

            # –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–¥–ø–∏—Å–∫—É
            update_data = SubscriptionUpdateFields(
                discount_percent=discount_percent,
                individual_price=new_price
            )
            self.subscription_repo.update(subscription.id, update_data)
```

### 6. –î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–µ—Å—á–µ—Ç—ã —Å–∫–∏–¥–æ–∫ –≤–æ –≤—Å–µ—Ö –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Ç–æ—á–∫–∞—Ö

#### 6.1. –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –Ω–æ–≤–æ–π –ø–æ–¥–ø–∏—Å–∫–∏

**–§–∞–π–ª:** `server/services/subscription_service.py`

```python
def create_subscription_order(self, request: SubscriptionCreateRequest) -> SubscriptionResponse:
    # ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏ ...

    # –ü–û–°–õ–ï —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —Å–∫–∏–¥–∫–∏ –¥–ª—è –≤—Å–µ—Ö –¥–µ—Ç–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    self.recalculate_discounts_for_user(child.parent_id)

    return subscription_response
```

#### 6.2. –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ø–ª–∞–Ω–∞ –ø–æ–¥–ø–∏—Å–∫–∏

**–§–∞–π–ª:** `server/services/subscription_service.py`

```python
def update_subscription(self, subscription_id: int, update_data: SubscriptionUpdateRequest) -> Optional[Subscription]:
    # ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è ...

    # –ü–û–°–õ–ï –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —Å–∫–∏–¥–∫–∏ –¥–ª—è –≤—Å–µ—Ö –¥–µ—Ç–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    subscription = self.subscription_repo.get_by_id(subscription_id)
    if subscription:
        self.recalculate_discounts_for_user(subscription.child.parent_id)

    return updated_subscription
```

#### 6.3. –ü—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –Ω–æ–≤–æ–≥–æ —Ä–µ–±–µ–Ω–∫–∞

**–§–∞–π–ª:** `server/services/child_service.py`

```python
def create_child(self, request: ChildCreateRequest) -> ChildResponse:
    # ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ —Å–æ–∑–¥–∞–Ω–∏—è —Ä–µ–±–µ–Ω–∫–∞ ...

    # –ü–û–°–õ–ï —Å–æ–∑–¥–∞–Ω–∏—è —Ä–µ–±–µ–Ω–∫–∞ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —Å–∫–∏–¥–∫–∏ –¥–ª—è –≤—Å–µ—Ö –¥–µ—Ç–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    subscription_service = SubscriptionService(self.db)
    subscription_service.recalculate_discounts_for_user(request.parent_id)

    return child_response
```

#### 6.4. –ü—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ä–µ–±–µ–Ω–∫–∞

**–§–∞–π–ª:** `server/services/child_service.py`

```python
def delete_child(self, child_id: int, user_id: int) -> bool:
    # ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ —É–¥–∞–ª–µ–Ω–∏—è —Ä–µ–±–µ–Ω–∫–∞ ...

    # –ü–û–°–õ–ï —É–¥–∞–ª–µ–Ω–∏—è —Ä–µ–±–µ–Ω–∫–∞ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —Å–∫–∏–¥–∫–∏ –¥–ª—è –æ—Å—Ç–∞–≤—à–∏—Ö—Å—è –¥–µ—Ç–µ–π
    subscription_service = SubscriptionService(self.db)
    subscription_service.recalculate_discounts_for_user(user_id)

    return True
```

#### 6.5. –ü—Ä–∏ –æ—Ç–º–µ–Ω–µ –ø–æ–¥–ø–∏—Å–∫–∏

**–§–∞–π–ª:** `server/services/subscription_service.py`

```python
def cancel_child_subscription_with_refund(self, child_id: int) -> bool:
    # ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ –æ—Ç–º–µ–Ω—ã –ø–æ–¥–ø–∏—Å–∫–∏ ...

    # –ü–û–°–õ–ï –æ—Ç–º–µ–Ω—ã –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —Å–∫–∏–¥–∫–∏ –¥–ª—è –≤—Å–µ—Ö –¥–µ—Ç–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    subscription = self.subscription_repo.get_by_id(child_id)
    if subscription:
        self.recalculate_discounts_for_user(subscription.child.parent_id)

    return True
```

#### 6.6. API —ç–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è —Ä—É—á–Ω–æ–≥–æ –ø–µ—Ä–µ—Å—á–µ—Ç–∞

**–§–∞–π–ª:** `server/api/subscriptions.py`

```python
@router.post("/recalculate-discounts", response_model=Dict[str, str])
async def recalculate_user_discounts(
    current_user: UserFromToken = Depends(get_current_user),
    subscription_service: SubscriptionService = Depends(get_subscription_service)
):
    """–ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç —Å–∫–∏–¥–∫–∏ –¥–ª—è –≤—Å–µ—Ö –ø–æ–¥–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    try:
        subscription_service.recalculate_discounts_for_user(current_user.id)
        return {"message": "–°–∫–∏–¥–∫–∏ –ø–µ—Ä–µ—Å—á–∏—Ç–∞–Ω—ã"}
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))
```

### 7. –û–±–Ω–æ–≤–∏—Ç—å —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥

**–§–∞–π–ª:** `web/src/components/auth/steps/PaymentStep.tsx`

```typescript
// –ü–æ–¥—Å—á–µ—Ç –æ–±—â–µ–π —Ü–µ–Ω—ã —Å —É—á–µ—Ç–æ–º —Å–∫–∏–¥–æ–∫
const totalPrice = useMemo(
  () =>
    children.reduce((sum, child) => {
      const pendingSubscription = child.subscriptions.filter(
        (subscription) =>
          subscription.status === SubscriptionStatus.pending_payment
      );
      if (pendingSubscription.length > 0) {
        let price = 0;

        for (const subscription of pendingSubscription) {
          // –ò—Å–ø–æ–ª—å–∑—É–µ–º individual_price –≤–º–µ—Å—Ç–æ plan.price_monthly
          price += subscription.individual_price || 0;
        }

        // –û–∫—Ä—É–≥–ª—è–µ–º —Ü–µ–Ω—É
        price = Math.round(price);

        return sum + price;
      }

      return sum;
    }, 0),
  [children]
);
```

**–§–∞–π–ª:** `web/src/widgets/child-info/ChildInfoWidget.tsx`

```typescript
{
  /* Subscription */
}
{
  subscriptionPlan && (
    <div className="mb-4">
      <p className="text-sm text-gray-600 mb-2">–¢–∞—Ä–∏—Ñ</p>
      <Tag>
        {subscriptionPlan?.name} ‚Ä¢ {subscriptionPlan?.toy_count} –∏–≥—Ä—É—à–µ–∫ ‚Ä¢ $
        {subscription?.individual_price || subscriptionPlan?.price_monthly} /–º–µ—Å
      </Tag>
    </div>
  );
}
```

### 8. –ú–∏–≥—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö

**–°–æ–∑–¥–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –¥–ª—è –ø–µ—Ä–µ—Å—á–µ—Ç–∞ —Ü–µ–Ω —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ø–æ–¥–ø–∏—Å–æ–∫:**

```python
# migration_script.py
def migrate_existing_subscriptions():
    """–ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç —Ü–µ–Ω—ã –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ø–æ–¥–ø–∏—Å–æ–∫"""
    subscriptions = db.query(Subscription).all()

    for subscription in subscriptions:
        # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Å–∫–∏–¥–∫—É
        discount_percent = subscription.discount_percent or 0.0

        # –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —Ü–µ–Ω—É
        new_price = subscription.plan.price_monthly * (1 - discount_percent / 100)

        # –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–¥–ø–∏—Å–∫—É
        subscription.individual_price = new_price

    db.commit()
```

## –ú–æ–º–µ–Ω—Ç—ã –ø–µ—Ä–µ—Å—á–µ—Ç–∞ —Å–∫–∏–¥–æ–∫

### –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Ç–æ—á–∫–∏ –¥–ª—è –ø–µ—Ä–µ—Å—á–µ—Ç–∞

–°–∫–∏–¥–∫–∏ –¥–æ–ª–∂–Ω—ã –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞—Ç—å—Å—è –≤ —Å–ª–µ–¥—É—é—â–∏—Ö —Å–ª—É—á–∞—è—Ö:

#### 1. **–ò–∑–º–µ–Ω–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –¥–µ—Ç–µ–π**

- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Ä–µ–±–µ–Ω–∫–∞
- ‚úÖ –£–¥–∞–ª–µ–Ω–∏–µ —Ä–µ–±–µ–Ω–∫–∞
- ‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ —Ä–µ–±–µ–Ω–∫–∞ (–∞–∫—Ç–∏–≤–µ–Ω/–Ω–µ–∞–∫—Ç–∏–≤–µ–Ω)

#### 2. **–ò–∑–º–µ–Ω–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–æ–∫**

- ‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π –ø–æ–¥–ø–∏—Å–∫–∏
- ‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏–µ –ø–ª–∞–Ω–∞ –ø–æ–¥–ø–∏—Å–∫–∏
- ‚úÖ –û—Ç–º–µ–Ω–∞ –ø–æ–¥–ø–∏—Å–∫–∏
- ‚úÖ –í–æ–∑–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏ –ø–æ—Å–ª–µ –ø–∞—É–∑—ã

#### 3. **–ò–∑–º–µ–Ω–µ–Ω–∏–µ –ø–ª–∞–Ω–æ–≤**

- ‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ü–µ–Ω—ã –ø–ª–∞–Ω–∞ (–µ—Å–ª–∏ —Ç–∞–∫–æ–µ –≤–æ–∑–º–æ–∂–Ω–æ)
- ‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–∞–≤–∞ –ø–ª–∞–Ω–∞

#### 4. **–°–∏—Å—Ç–µ–º–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è**

- ‚úÖ –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π –ø–µ—Ä–µ—Å—á–µ—Ç —á–µ—Ä–µ–∑ API
- ‚úÖ –ú–∏–≥—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ —Å–±–æ–µ–≤

### –õ–æ–≥–∏–∫–∞ –ø–µ—Ä–µ—Å—á–µ—Ç–∞

```python
def recalculate_discounts_for_user(self, user_id: int) -> None:
    """–ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç —Å–∫–∏–¥–∫–∏ –¥–ª—è –≤—Å–µ—Ö –ø–æ–¥–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    # 1. –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ—Ö –¥–µ—Ç–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    children = self.child_repo.get_by_parent_id(user_id)

    # 2. –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ –ø–æ–¥–ø–∏—Å–∫–∏ (–∏—Å–∫–ª—é—á–∞–µ–º –æ—Ç–º–µ–Ω–µ–Ω–Ω—ã–µ –∏ –∏—Å—Ç–µ–∫—à–∏–µ)
    subscriptions = []
    for child in children:
        # –ü–æ–ª—É—á–∞–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –ø–æ–¥–ø–∏—Å–∫—É
        subscription = self.subscription_repo.get_active_by_child_id(child.id)
        if subscription and subscription.status not in [SubscriptionStatus.CANCELLED, SubscriptionStatus.EXPIRED]:
            subscriptions.append(subscription)
            continue

        # –ü–æ–ª—É—á–∞–µ–º –æ–∂–∏–¥–∞—é—â—É—é –æ–ø–ª–∞—Ç—ã –ø–æ–¥–ø–∏—Å–∫—É
        subscription = self.subscription_repo.get_pending_payment_by_child_id(child.id)
        if subscription and subscription.status not in [SubscriptionStatus.CANCELLED, SubscriptionStatus.EXPIRED]:
            subscriptions.append(subscription)
            continue

        # –ü–æ–ª—É—á–∞–µ–º –ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—É—é –ø–æ–¥–ø–∏—Å–∫—É (–µ—Å–ª–∏ –µ—Å—Ç—å)
        paused_subscription = self.subscription_repo.get_paused_by_child_id(child.id)
        if paused_subscription and paused_subscription.status == SubscriptionStatus.PAUSED:
            subscriptions.append(paused_subscription)

    # 3. –ï—Å–ª–∏ –ø–æ–¥–ø–∏—Å–æ–∫ –º–µ–Ω—å—à–µ 2 - —Å–∫–∏–¥–æ–∫ –Ω–µ—Ç
    if len(subscriptions) <= 1:
        for subscription in subscriptions:
            self._update_subscription_price(subscription.id, 0.0)
        return

    # 4. –†–∞–∑–¥–µ–ª—è–µ–º –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ –æ–ø–ª–∞—á–µ–Ω–Ω—ã–µ –∏ –Ω–æ–≤—ã–µ
    paid_subscriptions = [
        s for s in subscriptions
        if s.payment and s.payment.status == PaymentStatus.COMPLETED
        and s.status in [SubscriptionStatus.ACTIVE, SubscriptionStatus.PAUSED]
    ]
    new_subscriptions = [
        s for s in subscriptions
        if not s.payment or s.payment.status != PaymentStatus.COMPLETED
        or s.status == SubscriptionStatus.PENDING_PAYMENT
    ]

    # 5. –ï—Å–ª–∏ –µ—Å—Ç—å —Ç–æ–ª—å–∫–æ –æ–ø–ª–∞—á–µ–Ω–Ω—ã–µ –ø–æ–¥–ø–∏—Å–∫–∏ - —Å–∫–∏–¥–æ–∫ –Ω–µ—Ç
    if not new_subscriptions:
        for subscription in subscriptions:
            self._update_subscription_price(subscription.id, 0.0)
        return

    # 6. –ï—Å–ª–∏ –µ—Å—Ç—å —Ç–æ–ª—å–∫–æ –Ω–æ–≤—ã–µ –ø–æ–¥–ø–∏—Å–∫–∏ - –ø—Ä–∏–º–µ–Ω—è–µ–º —Å—Ç–∞—Ä—É—é –ª–æ–≥–∏–∫—É
    if not paid_subscriptions:
        cheapest_subscription = min(subscriptions, key=lambda s: s.plan.price_monthly)
        for subscription in subscriptions:
            if subscription.id == cheapest_subscription.id:
                self._update_subscription_price(subscription.id, 20.0)
            else:
                self._update_subscription_price(subscription.id, 0.0)
        return

    # 7. –ï—Å–ª–∏ –µ—Å—Ç—å –∏ –æ–ø–ª–∞—á–µ–Ω–Ω—ã–µ, –∏ –Ω–æ–≤—ã–µ –ø–æ–¥–ø–∏—Å–∫–∏
    # –û–ø–ª–∞—á–µ–Ω–Ω—ã–µ –ø–æ–¥–ø–∏—Å–∫–∏ –æ—Å—Ç–∞–≤–ª—è–µ–º –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
    for subscription in paid_subscriptions:
        self._update_subscription_price(subscription.id, 0.0)

    # –ö –Ω–æ–≤—ã–º –ø–æ–¥–ø–∏—Å–∫–∞–º –ø—Ä–∏–º–µ–Ω—è–µ–º —Å–∫–∏–¥–∫—É
    if len(new_subscriptions) == 1:
        # –û–¥–Ω–∞ –Ω–æ–≤–∞—è –ø–æ–¥–ø–∏—Å–∫–∞ - –ø—Ä–∏–º–µ–Ω—è–µ–º –∫ –Ω–µ–π —Å–∫–∏–¥–∫—É
        self._update_subscription_price(new_subscriptions[0].id, 20.0)
    else:
        # –ù–µ—Å–∫–æ–ª—å–∫–æ –Ω–æ–≤—ã—Ö –ø–æ–¥–ø–∏—Å–æ–∫ - –ø—Ä–∏–º–µ–Ω—è–µ–º –∫ —Å–∞–º–æ–π –¥–µ—à–µ–≤–æ–π –∏–∑ –Ω–æ–≤—ã—Ö
        cheapest_new_subscription = min(new_subscriptions, key=lambda s: s.plan.price_monthly)
        for subscription in new_subscriptions:
            if subscription.id == cheapest_new_subscription.id:
                self._update_subscription_price(subscription.id, 20.0)
            else:
                self._update_subscription_price(subscription.id, 0.0)

def _update_subscription_price(self, subscription_id: int, discount_percent: float) -> None:
    """–û–±–Ω–æ–≤–ª—è–µ—Ç —Ü–µ–Ω—É –ø–æ–¥–ø–∏—Å–∫–∏ —Å —É—á–µ—Ç–æ–º —Å–∫–∏–¥–∫–∏"""
    subscription = self.subscription_repo.get_by_id(subscription_id)
    if subscription:
        new_price = subscription.plan.price_monthly * (1 - discount_percent / 100)
        update_data = SubscriptionUpdateFields(
            discount_percent=discount_percent,
            individual_price=new_price
        )
        self.subscription_repo.update(subscription_id, update_data)
```

### –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

#### –ü—Ä–æ–±–ª–µ–º—ã

- –ü–µ—Ä–µ—Å—á–µ—Ç –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –º–æ–∂–µ—Ç –±—ã—Ç—å –º–µ–¥–ª–µ–Ω–Ω—ã–º
- –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ë–î
- –í–æ–∑–º–æ–∂–Ω—ã–µ race conditions

#### –†–µ—à–µ–Ω–∏—è

1. **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤** - –∫—ç—à–∏—Ä–æ–≤–∞—Ç—å —Å–∫–∏–¥–∫–∏ –Ω–∞ 5-10 –º–∏–Ω—É—Ç
2. **Batch –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è** - –æ–±–Ω–æ–≤–ª—è—Ç—å –≤—Å–µ –ø–æ–¥–ø–∏—Å–∫–∏ –æ–¥–Ω–∏–º –∑–∞–ø—Ä–æ—Å–æ–º
3. **–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç—å** - –≤—ã–ø–æ–ª–Ω—è—Ç—å –ø–µ—Ä–µ—Å—á–µ—Ç –≤ —Ñ–æ–Ω–µ –¥–ª—è –Ω–µ–∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
4. **Debouncing** - –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∞—Ç—å —á–∞—Å—Ç—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è

```python
# –ü—Ä–∏–º–µ—Ä –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–µ—Ä–µ—Å—á–µ—Ç–∞
def recalculate_discounts_for_user_optimized(self, user_id: int) -> None:
    """–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–µ—Ä–µ—Å—á–µ—Ç —Å–∫–∏–¥–æ–∫"""
    cache_key = f"discounts_user_{user_id}"

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—ç—à
    cached_discounts = self.cache.get(cache_key)
    if cached_discounts:
        return cached_discounts

    # –í—ã–ø–æ–ª–Ω—è–µ–º –ø–µ—Ä–µ—Å—á–µ—Ç
    discounts = self._calculate_discount_for_user(user_id)

    # Batch –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Å–µ—Ö –ø–æ–¥–ø–∏—Å–æ–∫
    self._batch_update_subscription_prices(discounts)

    # –ö—ç—à–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
    self.cache.set(cache_key, discounts, timeout=300)  # 5 –º–∏–Ω—É—Ç
```

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –¢–µ—Å—Ç–æ–≤—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏

#### –ë–∞–∑–æ–≤—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏

1. **–û–¥–∏–Ω —Ä–µ–±–µ–Ω–æ–∫** - —Å–∫–∏–¥–∫–∞ –Ω–µ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è
2. **–î–≤–∞ —Ä–µ–±–µ–Ω–∫–∞ —Å –æ–¥–∏–Ω–∞–∫–æ–≤—ã–º–∏ –ø–ª–∞–Ω–∞–º–∏** - —Å–∫–∏–¥–∫–∞ 20% –∫ –æ–¥–Ω–æ–º—É –∏–∑ –ø–ª–∞–Ω–æ–≤
3. **–î–≤–∞ —Ä–µ–±–µ–Ω–∫–∞ —Å —Ä–∞–∑–Ω—ã–º–∏ –ø–ª–∞–Ω–∞–º–∏** - —Å–∫–∏–¥–∫–∞ 20% –∫ —Å–∞–º–æ–º—É –¥–µ—à–µ–≤–æ–º—É –ø–ª–∞–Ω—É
4. **–¢—Ä–∏ —Ä–µ–±–µ–Ω–∫–∞ —Å —Ä–∞–∑–Ω—ã–º–∏ –ø–ª–∞–Ω–∞–º–∏** - —Å–∫–∏–¥–∫–∞ 20% –∫ —Å–∞–º–æ–º—É –¥–µ—à–µ–≤–æ–º—É –ø–ª–∞–Ω—É
5. **–ò–∑–º–µ–Ω–µ–Ω–∏–µ –ø–ª–∞–Ω–∞** - –ø–µ—Ä–µ—Å—á–µ—Ç —Å–∫–∏–¥–æ–∫ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ø–ª–∞–Ω–∞

#### –°—Ü–µ–Ω–∞—Ä–∏–∏ —Å –æ–ø–ª–∞—á–µ–Ω–Ω—ã–º–∏ –ø–æ–¥–ø–∏—Å–∫–∞–º–∏

6. **–û–ø–ª–∞—á–µ–Ω–Ω–∞—è + –Ω–æ–≤–∞—è –ø–æ–¥–ø–∏—Å–∫–∞** - —Å–∫–∏–¥–∫–∞ —Ç–æ–ª—å–∫–æ –∫ –Ω–æ–≤–æ–π
7. **–î–≤–µ –æ–ø–ª–∞—á–µ–Ω–Ω—ã–µ + –Ω–æ–≤–∞—è** - —Å–∫–∏–¥–∫–∞ —Ç–æ–ª—å–∫–æ –∫ –Ω–æ–≤–æ–π
8. **–û–ø–ª–∞—á–µ–Ω–Ω–∞—è + –¥–≤–µ –Ω–æ–≤—ã–µ** - —Å–∫–∏–¥–∫–∞ –∫ —Å–∞–º–æ–π –¥–µ—à–µ–≤–æ–π –∏–∑ –Ω–æ–≤—ã—Ö

#### –°—Ü–µ–Ω–∞—Ä–∏–∏ —Å–æ —Å—Ç–∞—Ç—É—Å–∞–º–∏

9. **–û—Ç–º–µ–Ω–µ–Ω–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞** - –Ω–µ —É—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –≤ —Ä–∞—Å—á–µ—Ç–µ
10. **–ò—Å—Ç–µ–∫—à–∞—è –ø–æ–¥–ø–∏—Å–∫–∞** - –Ω–µ —É—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –≤ —Ä–∞—Å—á–µ—Ç–µ
11. **–ü—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω–∞—è –æ–ø–ª–∞—á–µ–Ω–Ω–∞—è** - —É—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –∫–∞–∫ –æ–ø–ª–∞—á–µ–Ω–Ω–∞—è
12. **–ü—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω–∞—è –Ω–µ–æ–ø–ª–∞—á–µ–Ω–Ω–∞—è** - —É—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –∫–∞–∫ –Ω–æ–≤–∞—è
13. **–ù–µ—É–¥–∞—á–Ω—ã–π –ø–ª–∞—Ç–µ–∂** - —É—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –∫–∞–∫ –Ω–æ–≤–∞—è –ø–æ–¥–ø–∏—Å–∫–∞
14. **–í–æ–∑–≤—Ä–∞—Ç –ø–ª–∞—Ç–µ–∂–∞** - –Ω–µ —É—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –≤ —Ä–∞—Å—á–µ—Ç–µ

#### –°—Ü–µ–Ω–∞—Ä–∏–∏ —Å –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–º–∏ —Å—Ç–∞—Ç—É—Å–∞–º–∏

15. **–û—Ç–º–µ–Ω–µ–Ω–Ω–∞—è + –∞–∫—Ç–∏–≤–Ω–∞—è + –Ω–æ–≤–∞—è** - —Å–∫–∏–¥–∫–∞ –∫ –Ω–æ–≤–æ–π
16. **–ò—Å—Ç–µ–∫—à–∞—è + –ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω–∞—è + –Ω–æ–≤–∞—è** - —Å–∫–∏–¥–∫–∞ –∫ –Ω–æ–≤–æ–π
17. **–í—Å–µ –æ—Ç–º–µ–Ω–µ–Ω—ã + –Ω–æ–≤–∞—è** - —Å–∫–∏–¥–∫–∞ –∫ –Ω–æ–≤–æ–π
18. **–í—Å–µ –∏—Å—Ç–µ–∫–ª–∏ + –Ω–æ–≤–∞—è** - —Å–∫–∏–¥–∫–∞ –∫ –Ω–æ–≤–æ–π

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

- [ ] –¶–µ–Ω—ã –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç —Å—Ç–æ–∏–º–æ—Å—Ç—å —Å–æ —Å–∫–∏–¥–∫–æ–π
- [ ] –û–±—â–∞—è —Å—É–º–º–∞ –ø–ª–∞—Ç–µ–∂–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è
- [ ] –°–∫–∏–¥–∫–∞ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∫ —Å–∞–º–æ–º—É –¥–µ—à–µ–≤–æ–º—É –ø–ª–∞–Ω—É
- [ ] –ü—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏/—É–¥–∞–ª–µ–Ω–∏–∏ –¥–µ—Ç–µ–π —Å–∫–∏–¥–∫–∏ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞—é—Ç—Å—è
- [ ] API –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –æ —Ü–µ–Ω–∞—Ö

## –†–∏—Å–∫–∏ –∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

### –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

1. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å** - –ø–µ—Ä–µ—Å—á–µ—Ç —Å–∫–∏–¥–æ–∫ –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –º–æ–∂–µ—Ç –±—ã—Ç—å –º–µ–¥–ª–µ–Ω–Ω—ã–º
2. **–ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö** - –Ω—É–∂–Ω–æ –æ–±–µ—Å–ø–µ—á–∏—Ç—å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é —Å–∫–∏–¥–æ–∫ –º–µ–∂–¥—É –ø–æ–¥–ø–∏—Å–∫–∞–º–∏
3. **–°–ª–æ–∂–Ω–æ—Å—Ç—å –ª–æ–≥–∏–∫–∏** - –±–∏–∑–Ω–µ—Å-–ø—Ä–∞–≤–∏–ª–∞ –º–æ–≥—É—Ç —É—Å–ª–æ–∂–Ω–∏—Ç—å—Å—è –≤ –±—É–¥—É—â–µ–º

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

1. **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ** - –∫—ç—à–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ä–∞—Å—á–µ—Ç–∞ —Å–∫–∏–¥–æ–∫
2. **–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç—å** - –≤—ã–ø–æ–ª–Ω—è—Ç—å –ø–µ—Ä–µ—Å—á–µ—Ç —Å–∫–∏–¥–æ–∫ –≤ —Ñ–æ–Ω–µ
3. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥** - –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —Å–∫–∏–¥–æ–∫
4. **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è** - –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω—É—é –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é –±–∏–∑–Ω–µ—Å-–ø—Ä–∞–≤–∏–ª

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–ü–æ—Å–ª–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ —ç—Ç–æ–≥–æ –ø–ª–∞–Ω–∞ —Å–∏—Å—Ç–µ–º–∞ –±—É–¥–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –ø—Ä–∏–º–µ–Ω—è—Ç—å —Å–∫–∏–¥–∫–∏ —Å–æ–≥–ª–∞—Å–Ω–æ –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–µ:

- 20% —Å–∫–∏–¥–∫–∞ –¥–ª—è –≤—Å–µ—Ö –¥–µ—Ç–µ–π –∫—Ä–æ–º–µ –ø–µ—Ä–≤–æ–≥–æ
- –°–∫–∏–¥–∫–∞ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∫ —Å–∞–º–æ–º—É –¥–µ—à–µ–≤–æ–º—É –ø–ª–∞–Ω—É
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –≤–∏–¥—è—Ç —Ä–µ–∞–ª—å–Ω—É—é —Å—Ç–æ–∏–º–æ—Å—Ç—å —Å —É—á–µ—Ç–æ–º —Å–∫–∏–¥–æ–∫
- –ü–ª–∞—Ç–µ–∂–∏ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

–ù–∏–∫–∞–∫–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ `ToyBox`, `Payment` –∏–ª–∏ –¥—Ä—É–≥–∏—Ö —Å—É—â–Ω–æ—Å—Ç—è—Ö –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è, —Ç–∞–∫ –∫–∞–∫ –æ–Ω–∏ –Ω–µ —Å–æ–¥–µ—Ä–∂–∞—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ü–µ–Ω–∞—Ö.
