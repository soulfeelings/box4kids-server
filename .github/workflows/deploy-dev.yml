name: ðŸš€ Deploy Box4Kids Server (dev)

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

on:
  workflow_dispatch:
    inputs:
      buildImage:
        description: "Build API image from Dockerfile?"
        required: true
        default: "true"
        type: choice
        options: ["true", "false"]
      resetDevEnvironment:
        description: "Reset environment (remove volumes/images)?"
        required: true
        default: "false"
        type: choice
        options: ["true", "false"]
      runMigrations:
        description: "Run Alembic migrations?"
        required: true
        default: "true"
        type: choice
        options: ["true", "false"]
      pullBaseImages:
        description: "Pull base images (postgres/redis) from registry?"
        required: true
        default: "false"
        type: choice
        options: ["true", "false"]
  push:
    branches: ["dev"]

env:
  COMPOSE_PROJECT_NAME: box4kids-server

jobs:
  deploy:
    runs-on: [self-hosted, backend]
    environment: development

    steps:
      - name: âœ… Checkout repo
        uses: actions/checkout@v4

      - name: ðŸ“¦ Create .env
        run: |
          cat > .env << 'EOF'
          ENVIRONMENT=production
          DEBUG=true

          POSTGRES_DB=${{ vars.POSTGRES_DB }}
          POSTGRES_USER=${{ vars.POSTGRES_USER }}
          POSTGRES_PASSWORD=${{ vars.POSTGRES_PASSWORD }}
          DATABASE_URL=${{ vars.DATABASE_URL }}

          REDIS_URL=${{ vars.REDIS_URL }}

          SECRET_KEY=${{ vars.SECRET_KEY }}

          CLICK_MERCHANT_ID=${{ vars.CLICK_MERCHANT_ID }}
          CLICK_SECRET_KEY=${{ vars.CLICK_SECRET_KEY }}
          CLICK_SERVICE_ID=${{ vars.CLICK_SERVICE_ID }}
          CLICK_MERCHANT_USER_ID=${{ vars.CLICK_MERCHANT_USER_ID }}

          PAYME_TEST_MODE=true
          PAYME_MERCHANT_ID=${{ vars.PAYME_MERCHANT_ID }}
          PAYME_SECRET_KEY=${{ vars.PAYME_SECRET_KEY }}
          PAYME_SUBSCRIBE_API_URL=${{ vars.PAYME_SUBSCRIBE_API_URL }}
          PAYME_MERCHANT_API_URL=${{ vars.PAYME_MERCHANT_API_URL }}

          SMS_ENABLED=false
          SMS_LOGIN=${{ vars.SMS_LOGIN }}
          SMS_PASSWORD=${{ vars.SMS_PASSWORD }}
          SMS_NICKNAME=${{ vars.SMS_NICKNAME }}
          EOF

      - name: ðŸ’£ Reset environment (optional)
        if: ${{ github.event_name == 'workflow_dispatch' && inputs.resetDevEnvironment == 'true' }}
        run: |
          docker compose -f docker-compose.dev.yml down -v --remove-orphans --filter name=${{ env.COMPOSE_PROJECT_NAME }} || true
          docker image prune -f --filter label=com.docker.compose.project=${{ env.COMPOSE_PROJECT_NAME }} || true
          docker builder prune -f --filter label=com.docker.compose.project=${{ env.COMPOSE_PROJECT_NAME }} || true
          docker volume ls --filter label=com.docker.compose.project=${{ env.COMPOSE_PROJECT_NAME }} -q | xargs -r docker volume rm

      - name: â¬‡ï¸ Pull base images (optional)
        if: ${{ github.event_name == 'workflow_dispatch' && inputs.pullBaseImages == 'true' }}
        run: |
          docker compose -f docker-compose.dev.yml pull postgres redis

      - name: ðŸ—ï¸ (Optional) Build API image
        if: ${{ (github.event_name == 'workflow_dispatch' && inputs.buildImage == 'true') || github.event_name == 'push' }}
        run: |
          docker build -t box4kids-server-api:dev -f Dockerfile .

      - name: ðŸ˜ Ensure Postgres & Redis (no recreate)
        run: |
          # Ð¡Ð¾Ð·Ð´Ð°ÑÑ‚, ÐµÑÐ»Ð¸ Ð¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÑŽÑ‚; ÐµÑÐ»Ð¸ ÑƒÐ¶Ðµ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½Ñ‹ â€” Ð½Ðµ Ñ‚Ñ€Ð¾Ð½ÐµÑ‚
          docker compose -f docker-compose.dev.yml up -d --no-recreate postgres redis

      - name: â³ Wait for Postgres healthy
        run: |
          CID="$(docker compose -f docker-compose.dev.yml ps -q postgres)"
          for i in {1..60}; do
            STATUS="$(docker inspect -f '{{.State.Health.Status}}' "$CID" 2>/dev/null || echo starting)"
            echo "Postgres health: $STATUS"
            [ "$STATUS" = "healthy" ] && exit 0
            sleep 2
          done
          docker compose -f docker-compose.dev.yml logs postgres --tail=200
          exit 1

      - name: ðŸ§± Run Alembic migrations
        if: ${{ (github.event_name == 'workflow_dispatch' && inputs.runMigrations == 'true') || github.event_name == 'push' }}
        run: |
          docker compose -f docker-compose.dev.yml run --rm migrate

      - name: ðŸš€ Start API
        run: |
          docker compose -f docker-compose.dev.yml up -d --no-deps --force-recreate api

      - name: â¤ï¸ API healthcheck
        run: |
          for i in {1..30}; do
            curl -fsS http://127.0.0.1:8000/health >/dev/null && exit 0
            echo "waiting API... ($i)"; sleep 2
          done
          docker compose -f docker-compose.dev.yml logs api --tail=200
          exit 1
