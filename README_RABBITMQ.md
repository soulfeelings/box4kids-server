# Box4Kids + RabbitMQ Integration

## ๐ ะะฐะฟััะบ ัะธััะตะผั

### 1. ะะปั ัะฐะทัะฐะฑะพัะบะธ (ัะฟัะพัะตะฝะฝะพ)

```bash
# ะะฐะฟััะบ ะฒัะตั ัะตัะฒะธัะพะฒ ะดะปั ัะฐะทัะฐะฑะพัะบะธ
docker-compose up -d

# ะัะพัะผะพัั ะปะพะณะพะฒ
docker-compose logs -f api
```

**ะะพัััะฟ:**

- **API**: http://localhost:8000
- **RabbitMQ Management**: http://localhost:15672 (**guest/guest** - ะฑะตะท ะฟะฐัะพะปั!)
- **PostgreSQL**: localhost:5432
- **Redis**: localhost:6379

### 2. ะะปั ะฟัะพะดะฐะบัะตะฝะฐ (ะฑะตะทะพะฟะฐัะฝะพ)

```bash
# ะกะพะทะดะฐะนัะต ัะฐะนะป ั ะฟะตัะตะผะตะฝะฝัะผะธ ะพะบััะถะตะฝะธั
cp environment.prod.example .env.prod
# ะะฐะฟะพะปะฝะธัะต ัะตะฐะปัะฝัะผะธ ะฟะฐัะพะปัะผะธ ะฒ .env.prod

# ะะฐะฟััะบ ะดะปั ะฟัะพะดะฐะบัะตะฝะฐ
docker-compose -f docker-compose.prod.yml --env-file .env.prod up -d
```

**ะัะพะฑะตะฝะฝะพััะธ ะฟัะพะดะฐะบัะตะฝะฐ:**

- โ ะะตะทะพะฟะฐัะฝัะต ะฟะฐัะพะปะธ ะธะท ะฟะตัะตะผะตะฝะฝัั ะพะบััะถะตะฝะธั
- โ RabbitMQ Management UI ะะ ะดะพัััะฟะตะฝ ะธะทะฒะฝะต
- โ ะัะต ัะตัะฒะธัั ะฒ ะธะทะพะปะธัะพะฒะฐะฝะฝะพะน ัะตัะธ

### 3. ะะฒัะพะผะฐัะธัะตัะบะธะน ะทะฐะฟััะบ ะฒะพัะบะตัะฐ

ะะพัะบะตั ToyBox ัะตะฟะตัั **ะฐะฒัะพะผะฐัะธัะตัะบะธ ะทะฐะฟััะบะฐะตััั** ะฒะผะตััะต ั API ัะตัะฒะตัะพะผ ัะตัะตะท FastAPI `lifespan`:

- ะัะธ ััะฐััะต API โ ะทะฐะฟััะบะฐะตััั ToyBox ะฒะพัะบะตั
- ะัะธ ะพััะฐะฝะพะฒะบะต API โ ะฒะพัะบะตั ะบะพััะตะบัะฝะพ ะทะฐะฒะตััะฐะตััั

## ๐ Event-driven ะฟะพัะพะบ

### ะฃัะฟะตัะฝะฐั ะพะฟะปะฐัะฐ โ ะกะพะทะดะฐะฝะธะต ToyBox

1. **ะะพะปัะทะพะฒะฐัะตะปั** ะทะฐะฒะตััะฐะตั ะพะฟะปะฐัั
2. **PaymentService** ะพะฑัะฐะฑะฐััะฒะฐะตั ะฟะปะฐัะตะถ
3. **ะัะฑะปะธะบัะตั ัะพะฑััะธะต** `payment.processed` ะฒ RabbitMQ
4. **ToyBoxWorker** ะฐะฒัะพะผะฐัะธัะตัะบะธ ะฟะพะปััะฐะตั ัะพะฑััะธะต
5. **ะกะพะทะดะฐะตั ToyBox** ะดะปั ัะตะฑะตะฝะบะฐ
6. **ะัะฑะปะธะบัะตั ัะพะฑััะธะต** `toybox.created` ะดะปั ัะฒะตะดะพะผะปะตะฝะธะน

### ะัะธะผะตั ัะพะฑััะธั

```json
{
  "user_id": 123,
  "payment_id": 456,
  "child_id": 789,
  "subscription_id": 101
}
```

## ๐ ะะพะฝะธัะพัะธะฝะณ

### RabbitMQ Management UI

- ะัะตัะตะดะธ: `toybox_queue`, `notifications_queue`
- Exchange: `box4kids_events`
- Routing keys: `payment.processed`, `toybox.created`

### ะะพะณะธ ัะตัะฒะตัะฐ

```bash
# ะัะพัะผะพัั ะปะพะณะพะฒ API + ะฒะพัะบะตัะฐ
docker-compose logs -f api

# ะะพะธัะบ ะฟะพ ะปะพะณะฐะผ
docker-compose logs api | grep "ToyBox worker"
```

## ๐๏ธ ะะปั ัะฐะทัะฐะฑะพัะบะธ

### ะะพะบะฐะปัะฝัะน ะทะฐะฟััะบ (ะฑะตะท Docker)

```bash
# 1. ะะฐะฟััะบ ัะพะปัะบะพ ะธะฝััะฐััััะบัััั
docker-compose up -d postgres redis rabbitmq

# 2. ะะฐะฟััะบ API ัะตัะฒะตัะฐ (ะฒะพัะบะตั ะทะฐะฟัััะธััั ะฐะฒัะพะผะฐัะธัะตัะบะธ)
python main.py

# 3. ะฃััะฐะฝะพะฒะบะฐ ะทะฐะฒะธัะธะผะพััะตะน
pip install pika==1.3.2
```

### ะัะปะฐะดะบะฐ ะฒะพัะบะตัะฐ

```bash
# ะะฐะฟััะบ ัะพะปัะบะพ ะฒะพัะบะตัะฐ (ะดะปั ะพัะปะฐะดะบะธ)
python start_worker.py toybox
```

## ๐ ะะฐััะธััะตะผะพััั

### ะะพะฑะฐะฒะปะตะฝะธะต ะฝะพะฒัั ะฒะพัะบะตัะพะฒ

1. ะกะพะทะดะฐัั ัะฐะนะป `workers/notification_worker.py`
2. ะะพะฑะฐะฒะธัั ะฒ `main.py` lifespan ััะฝะบัะธั
3. ะะฐัะตะณะธัััะธัะพะฒะฐัั ะฝะพะฒัะต routing keys

### ะะพะฒัะต ัะพะฑััะธั

```python
# ะ core/messaging.py
class NotificationSentEvent(BaseEvent):
    def get_routing_key(self) -> str:
        return 'notification.sent'

# ะ ะฒะพัะบะตัะต
consumer.register_handler('notification.sent', handle_notification)
```

## ๐ง ะััะธัะตะบัััะฐ

```
โโโโโโโโโโโโโโโโโโโ    โโโโโโโโโโโโโโโโโโโ    โโโโโโโโโโโโโโโโโโโ
โ  PaymentService โ    โ    RabbitMQ     โ    โ  ToyBoxWorker   โ
โ                 โ    โ                 โ    โ                 โ
โ  โ ะะฟะปะฐัะฐ       โโโโโถโ  payment.       โโโโโถโ  ะกะพะทะดะฐะตั        โ
โ  โ ะกะพะฑััะธะต      โ    โ  processed      โ    โ  ToyBox         โ
โ                 โ    โ                 โ    โ                 โ
โโโโโโโโโโโโโโโโโโโ    โโโโโโโโโโโโโโโโโโโ    โโโโโโโโโโโโโโโโโโโ
         โ                                              โ
         โ                                              โผ
         โ                                   โโโโโโโโโโโโโโโโโโโ
         โ                                   โNotificationWorkerโ
         โ                                   โ                 โ
         โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโถ  โ  ะัะฟัะฐะฒะปัะตั     โ
                                             โ  ัะฒะตะดะพะผะปะตะฝะธั    โ
                                             โ                 โ
                                             โโโโโโโโโโโโโโโโโโโ
```

## โ ะขะตััะธัะพะฒะฐะฝะธะต

### ะัะพะฒะตัะบะฐ ัะฐะฑะพัั ัะธััะตะผั

1. ะกะพะทะดะฐัั ะฟะพะปัะทะพะฒะฐัะตะปั ัะตัะตะท API
2. ะกะพะทะดะฐัั ะฟะพะดะฟะธัะบั
3. ะะฑัะฐะฑะพัะฐัั ะฟะปะฐัะตะถ
4. ะัะพะฒะตัะธัั ัะพะทะดะฐะฝะธะต ToyBox
5. ะัะพะฒะตัะธัั ะปะพะณะธ ะฒะพัะบะตัะฐ

### ะัะธะผะตั API ะฒัะทะพะฒะพะฒ

```bash
# ะกะพะทะดะฐะฝะธะต ะฟะปะฐัะตะถะฐ
curl -X POST "http://localhost:8000/payments/batch" \
  -H "Content-Type: application/json" \
  -d '{"subscription_ids": [1]}'

# ะะฑัะฐะฑะพัะบะฐ ะฟะปะฐัะตะถะฐ
curl -X POST "http://localhost:8000/payments/1/process"
```

## ๐ฏ ะะตะทัะปััะฐั

โ **ะะฐะทะฒัะทะบะฐ ัะตัะฒะธัะพะฒ** - PaymentService ะฝะต ะทะฝะฐะตั ะพ ToyBoxService  
โ **ะะฐะดะตะถะฝะพััั** - ัะพะฑััะธั ัะพััะฐะฝััััั ะฒ RabbitMQ  
โ **ะะฐัััะฐะฑะธััะตะผะพััั** - ะผะพะถะฝะพ ะดะพะฑะฐะฒะธัั ะฑะพะปััะต ะฒะพัะบะตัะพะฒ  
โ **ะะพะฝะธัะพัะธะฝะณ** - ะฒะตะฑ-ะธะฝัะตััะตะนั RabbitMQ  
โ **ะะฒัะพะผะฐัะธะทะฐัะธั** - ะฒะพัะบะตั ะทะฐะฟััะบะฐะตััั ั ัะตัะฒะตัะพะผ
